<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cardano Payroll System</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial,
          sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow-x: hidden;
      }
      h1 {
        margin-top: 0;
        color: #333;
      }
      h2 {
        color: #555;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 10px;
        margin-top: 30px;
      }
      h3 {
        color: #666;
        margin-top: 20px;
      }
      button {
        background: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }
      button:hover {
        background: #45a049;
      }
      button[type="submit"] {
        margin-top: 10px;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      .status {
        margin-top: 20px;
        padding: 12px;
        background: #e8f5e9;
        border-radius: 4px;
        border-left: 4px solid #4caf50;
      }
      .table-wrapper {
        overflow-x: auto;
        margin-top: 15px;
        border: 1px solid #eee;
        border-radius: 4px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
      }
      td {
        padding: 10px 12px;
        border-top: 1px solid #eee;
        max-width: 0;
      }
      tr:hover {
        background: #f9f9f9;
      }
      td:nth-child(1) {
        width: 60px;
        text-align: center;
      }
      td:nth-child(2) {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #transactions-table td:nth-child(2) {
        max-width: 450px;
        word-break: break-all;
        overflow-wrap: break-word;
      }
      .tx-hash {
        font-family: "Courier New", monospace;
        font-size: 0.85em;
        word-break: break-all;
        overflow-wrap: break-word;
        display: block;
      }
      .address-cell {
        font-size: 0.9em;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
      }
      .tx-hash a {
        color: #4caf50;
        text-decoration: none;
      }
      .tx-hash a:hover {
        text-decoration: underline;
      }
      .run-payroll-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Cardano Payroll System</h1>

      <div id="status" class="status" style="display: none"></div>

      <div class="run-payroll-section">
        <h2 style="margin-top: 0; border: none">Payroll Scheduler</h2>
        <button id="run-payroll-btn">Start Payroll</button>
        <p style="margin: 10px 0 0 0; color: #666; font-size: 0.9em">
          Starts automated payroll every 2 minutes
        </p>
      </div>

      <h2>Recipients</h2>
      <div id="recipients-section">
        <form id="recipient-form">
          <input
            type="text"
            id="pr-address"
            placeholder="Cardano Address (addr_test1...)"
            required
          />
          <input
            type="number"
            id="pr-amount"
            placeholder="Amount (tADA)"
            step="0.000001"
            min="0"
            required
          />
          <button type="submit">Add Recipient</button>
        </form>

        <div class="table-wrapper">
          <table id="recipients-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Address</th>
                <th>Amount (tADA)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <h2>Transaction History</h2>
      <div class="table-wrapper">
        <table id="transactions-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Transaction Hash</th>
              <th>Date & Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script type="module">
      import {
        getRecipients,
        createRecipient,
        deleteRecipient,
        runPayroll,
        getTransactions,
      } from "./payroll-client.js";

      function updateStatus(message) {
        const statusEl = document.getElementById("status");
        statusEl.innerHTML = message;
        statusEl.style.display = message ? "block" : "none";
      }

      const recipientsTableBody = document.querySelector(
        "#recipients-table tbody"
      );
      const recipientForm = document.getElementById("recipient-form");
      const transactionsTableBody = document.querySelector(
        "#transactions-table tbody"
      );

      async function loadRecipients() {
        try {
          const recipients = await getRecipients();
          recipientsTableBody.innerHTML = "";
          recipients.forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
          <td>${r.id}</td>
          <td><span class="address-cell" title="${r.address}">${
              r.address
            }</span></td>
          <td>${(Number(r.amount) / 1_000_000).toFixed(6)}</td>
          <td>
            <button data-id="${r.id}" data-action="delete">Delete</button>
          </td>
        `;
            recipientsTableBody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          updateStatus("Error loading recipients: " + err.message);
        }
      }

      recipientForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const address = document.getElementById("pr-address").value.trim();
        const amount = Number(document.getElementById("pr-amount").value);

        if (!address || !amount) {
          updateStatus("Please fill in recipient address and amount");
          return;
        }

        try {
          await createRecipient({ address, amount });
          recipientForm.reset();
          await loadRecipients();
        } catch (err) {
          console.error(err);
          updateStatus("Error adding recipient: " + err.message);
        }
      });

      recipientsTableBody.addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const id = Number(btn.dataset.id);
        const action = btn.dataset.action;

        if (action === "delete") {
          if (!confirm("Are you sure you want to delete this recipient?"))
            return;
          try {
            await deleteRecipient(id);
            await loadRecipients();
          } catch (err) {
            console.error(err);
            updateStatus("Error deleting recipient: " + err.message);
          }
        }
      });

      async function loadTransactions() {
        try {
          const transactions = await getTransactions();
          transactionsTableBody.innerHTML = "";
          if (transactions.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="3" style="text-align: center; color: #999; padding: 20px;">No transactions yet</td>`;
            transactionsTableBody.appendChild(tr);
          } else {
            transactions.forEach((tx, index) => {
              const tr = document.createElement("tr");
              const date = new Date(tx.created_at);
              const dateStr = date.toLocaleString();
              tr.innerHTML = `
            <td>${transactions.length - index}</td>
            <td>
              <a href="https://preprod.cardanoscan.io/transaction/${
                tx.tx_hash
              }" target="_blank" class="tx-hash" style="color: #4caf50;" title="${
                tx.tx_hash
              }">
                ${tx.tx_hash}
              </a>
            </td>
            <td>${dateStr}</td>
          `;
              transactionsTableBody.appendChild(tr);
            });
          }
        } catch (err) {
          console.error(err);
          updateStatus("Error loading transactions: " + err.message);
        }
      }

      document
        .getElementById("run-payroll-btn")
        .addEventListener("click", async () => {
          try {
            updateStatus("Starting scheduler... First run in ~2 minutes.");
            const result = await runPayroll();
            const newTxHash = result.txHash;
            updateStatus(`Scheduler started. Waiting for transactions...`);

            const initialTransactions = await getTransactions();
            let lastSeenCount = initialTransactions.length;
            const pollIntervalMs = 6000;

            const poll = async () => {
              try {
                const transactions = await getTransactions();
                if (transactions.length > lastSeenCount) {
                  lastSeenCount = transactions.length;
                  await loadTransactions();
                  const latestTx = transactions[0];
                  updateStatus(
                    `Transaction completed!<br>` +
                      `<a href="https://preprod.cardanoscan.io/transaction/${latestTx.tx_hash}" target="_blank">View on Explorer</a>`
                  );
                }
              } catch (err) {
                console.error("Error polling transactions:", err);
              }
              setTimeout(poll, pollIntervalMs);
            };

            setTimeout(poll, pollIntervalMs);
          } catch (err) {
            console.error(err);
            updateStatus("Error: " + err.message);
          }
        });

      loadRecipients();
      loadTransactions();
    </script>
  </body>
</html>
